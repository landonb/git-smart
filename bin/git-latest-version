#!/usr/bin/env bash
# vim:tw=0:ts=2:sw=2:et:norl:ft=bash
# Author: Landon Bouma (landonb &#x40; retrosoft &#x2E; com)
# Project: https://github.com/landonb/git-smart#ðŸ’¡
# License: MIT. Please find more in the LICENSE file.

# Prints latest version tag.

# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ #

source_deps () {
  # Load git_latest_version_basetag, etc.
  . "$(dirname "$(realpath "$0")")/../deps/sh-git-nubs/bin/git-nubs.sh"
}

# ***

latest_version_fulltag () {
  local basevers="$1"
  git tag -l "${basevers}*" -l "v${basevers}*" |
    /usr/bin/env sed -E "s/${GITSMART_RE_VERSPARTS}/\6,\1.\2.\4\5\6/" |
    sort -r -n |
    head -n1 |
    /usr/bin/env sed -E "s/^[^,]*,//"
}

latest_version_tag () {
  local basevers="$(git_latest_version_basetag)"
  # See if basevers really tagged or if gleaned from alpha.
  if git show-ref --tags -- "${basevers}" > /dev/null; then
    fullvers="${basevers}"
  else
    # Assemble alpha-number-prefixed versions to sort and grab largest alpha.
    fullvers="$(latest_version_fulltag "${basevers}")"
  fi
  [ -z "${fullvers}" ] || echo "${fullvers}"
}

# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ #

main () {
  source_deps

  latest_version_tag "$@"
}

if [ "$0" = "${BASH_SOURCE[0]}" ]; then
  main "${@}"
fi

